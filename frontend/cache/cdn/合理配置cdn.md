内容分发网络(Content Delivery Network,简称CDN)是利用最靠近每一位用户的服务器，更快、更可靠地将文件发送给用户分发网络。

### 优点：

1. 提速:会给用户指派较近、较顺畅的服务器节点，将数据传输给用户
2. 低成本:服务器被放到不同地点，减少了互连的流量,也降低了带宽成本
3. 高可用度:当某个服务器故障时，自动调用邻近地区的服务器

### CDN回源：

回源是指浏览器访问CDN集群上静态文件时，文件缓存过期，直接穿透CDN集群
而访问源站机器的形为。

### 三级缓存：

浏览器本地缓存、CDN边缘节点缓存、CDN 源站缓存

缓存设置:缓存时间设置的过短，CDN边缘节点缓存经常失效，导致频繁回源,增
大了源站负载，访问也慢;缓存时间设置的过长,文件更新慢，用户本地缓存不能
及时更新;

不同静态资源类型缓存时间:
●HTML: 3分钟
●JS、 CSS: 10分钟、1天、30天

### CDN 灰度发布

原理:在部分地区、部分地区的部分运营商优先发布静态资源，验证通过后，再进
行全量发布。

 实施:域名方面，设置特殊VIP解析至要灰度的城市、运营商;源站机器方面，给
灰度的城市、运营商配置单独源站机器;灰度的城市、运营商解析至这些特有机器
上。

CDN大促备战


- 增加机房带宽
- 增加运营商流量
- 灾备: CDN应用缓存时间由10分钟设置成1个小时，大促后恢复。



### CDN:**全局负载均衡**和**缓存系统**

全局负载均衡（Global Sever Load Balance） GSLB，它是 CDN 的“大脑”，主要的职责是当用户接入网络的时候在 CDN 专网中挑选出一个“最佳”节点提供服务，解决的是用户如何找到“最近的”边缘节点，对整个 CDN 网络进行“负载均衡”。

#### GSLB 最常见的实现方式是“**DNS 负载均衡**”。

原来没有 CDN 的时候，权威 DNS 返回的是网站自己服务器的实际 IP 地址，浏览器收到 DNS 解析结果后直连网站。加入 CDN 后权威 DNS 返回的不是 IP 地址，而是一个 CNAME( Canonical Name ) 别名记录，指向 CDN 的 GSLB，“我这里暂时没法给你真正的地址，你去另外一个地方再查查看吧。”

因为没拿到 IP 地址，于是本地 DNS 就会向 GSLB 再发起请求，这样就进入了 CDN 的全局负载均衡系统，开始“智能调度”，主要的依据有这么几个：

1. 看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点；
2. 看用户所在的运营商网络，找相同网络的边缘节点；
3. 检查边缘节点的负载情况，找负载较轻的节点；
4. 其他，比如节点的“健康状况”、服务能力、带宽、响应时间等。

## CDN 的缓存代理

两个 CDN 的关键概念：“**命中**”和“**回源**”。

“命中”就是指用户访问的资源恰好在缓存系统里，可以直接返回给用户；“回源”则正相反，缓存里没有，必须用代理的方式回源站取。

两个衡量 CDN 服务质量的指标：“**命中率**”和“**回源率**”。

首先，最基本的方式就是在存储系统上下功夫。软件方面则不断“求新求变”，各种新的存储软件都会拿来尝试，比如 Memcache、Redis、Ceph，尽可能地高效利用存储，存下更多的内容。

其次，缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户。回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，这样最终“扇入度”就缩小了，可以有效地减少真正的回源。

第三个就是使用高性能的缓存服务，据我所知，目前国内的 CDN 厂商内部都是基于开源软件定制的。最常用的是专门的缓存代理软件 Squid、Varnish，还有新兴的 ATS（Apache Traffic Server），而 Nginx 和 OpenResty 作为 Web 服务器领域的“多面手”，凭借着强大的反向代理能力和模块化、易于扩展的优点，也在 CDN 里占据了不少的份额。





